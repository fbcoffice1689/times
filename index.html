<!DOCTYPE html>
<html lang="en">
Â  Â <head>
Â  Â  Â  <meta charset="UTF-8">
Â  Â  Â  <title>ðŸ§­ Hybrid Time & Task Dashboard</title>
Â  Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  Â <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/4/4a/Clock_icon_simple.svg">
Â  Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  Â  <style>
Â  Â  Â  Â  Â body {
Â  Â  Â  Â  Â font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â background-color: #f0f4f8; /* Light background */
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .card {
Â  Â  Â  Â  Â box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â transition: transform 0.2s;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .task-item {
Â  Â  Â  Â  Â padding: 12px;
Â  Â  Â  Â  Â border-left-width: 4px;Â 
Â  Â  Â  Â  Â transition: background-color 0.15s ease;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .status-pill {
Â  Â  Â  Â  Â display: inline-flex;
Â  Â  Â  Â  Â align-items: center;
Â  Â  Â  Â  Â padding: 4px 10px;
Â  Â  Â  Â  Â border-radius: 9999px;
Â  Â  Â  Â  Â font-size: 0.875rem;
Â  Â  Â  Â  Â font-weight: 600;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â /* Custom styles for loading state */
Â  Â  Â  Â  Â .loading-shimmer {
Â  Â  Â  Â  Â background: #e0e0e0;
Â  Â  Â  Â  Â background-image: linear-gradient(to right, #e0e0e0 0%, #f5f5f5 20%, #e0e0e0 40%, #e0e0e0 100%);
Â  Â  Â  Â  Â background-repeat: no-repeat;
Â  Â  Â  Â  Â background-size: 800px 104px;Â 
Â  Â  Â  Â  Â animation-duration: 1.5s;
Â  Â  Â  Â  Â animation-fill-mode: forwards;Â 
Â  Â  Â  Â  Â animation-iteration-count: infinite;
Â  Â  Â  Â  Â animation-name: shimmer;
Â  Â  Â  Â  Â animation-timing-function: linear;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â @keyframes shimmer {
Â  Â  Â  Â  Â 0% { background-position: -468px 0; }
Â  Â  Â  Â  Â 100% { background-position: 468px 0; }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .loading-text { color: transparent; }
Â  Â  Â  Â  Â /* Mobile optimizations */
Â  Â  Â  Â  Â @media (max-width: 640px) {
Â  Â  Â  Â  Â /* â— FIX: Force max-width of container to 100% on small screens */
Â  Â  Â  Â  Â #app-container {
Â  Â  Â  Â  Â max-width: 100% !important;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .status-pill {
Â  Â  Â  Â  Â font-size: 0.75rem;
Â  Â  Â  Â  Â padding: 3px 8px;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .task-item {
Â  Â  Â  Â  Â padding: 10px;
Â  Â  Â  Â  Â /* Ensure vertical stacking and alignment on small screens */
Â  Â  Â  Â  Â flex-direction: column;
Â  Â  Â  Â  Â align-items: flex-start !important;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .task-item > div:last-child {
Â  Â  Â  Â  Â margin-top: 8px;
Â  Â  Â  Â  Â width: 100%; /* Forces button container to full width */
Â  Â  Â  Â  Â justify-content: flex-end;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â button {
Â  Â  Â  Â  Â min-height: 44px; /* Touch-friendly size */
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â /* FIX FOR PRINTING:Â 
Â  Â  Â  Â  Â * Ensure only the report is visible and formatted for print.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â @media print {
Â  Â  Â  Â  Â .no-print {
Â  Â  Â  Â  Â display: none !important;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â #log-history-list {
Â  Â  Â  Â  Â max-height: none !important; /* Allows the content to expand fully */
Â  Â  Â  Â  Â overflow: visible !important; /* Disables the scrollbar */
Â  Â  Â  Â  Â border: none !important;Â  Â  Â  /* Removes the border from the printout */
Â  Â  Â  Â  Â padding: 0 !important;Â  Â  Â  Â  /* Removes the padding from the printout */
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â #log-report-container {
Â  Â  Â  Â  Â position: absolute;
Â  Â  Â  Â  Â left: 0;
Â  Â  Â  Â  Â top: 0;
Â  Â  Â  Â  Â width: 100%;
Â  Â  Â  Â  Â margin: 0;
Â  Â  Â  Â  Â padding: 20px;
Â  Â  Â  Â  Â box-shadow: none;Â 
Â  Â  Â  Â  Â page-break-after: always;Â 
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .print-header {
Â  Â  Â  Â  Â display: block !important; /* <--- This overrides the 'hidden' class during print */
Â  Â  Â  Â  Â text-align: center;
Â  Â  Â  Â  Â margin-bottom: 20px;
Â  Â  Â  Â  Â padding-bottom: 10px;
Â  Â  Â  Â  Â border-bottom: 2px solid #374151; /* Dark line under header */
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .print-table {
Â  Â  Â  Â  Â width: 100%;
Â  Â  Â  Â  Â border-collapse: collapse;
Â  Â  Â  Â  Â margin-top: 15px;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .print-table th, .print-table td {
Â  Â  Â  Â  Â border: 1px solid #ccc;
Â  Â  Â  Â  Â padding: 8px;
Â  Â  Â  Â  Â text-align: left;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â .print-table th {
Â  Â  Â  Â  Â background-color: #f3f4f6;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â /* Ensure the main app container is not hidden */
Â  Â  Â  Â  Â #app-container {
Â  Â  Â  Â  Â width: 100% !important;
Â  Â  Â  Â  Â max-width: none !important;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  </style>
Â  Â </head>
Â  Â <body class="py-4 px-0 sm:p-8 min-h-screen flex items-start justify-center">
Â  Â  Â  <div id="app-container" class="w-full max-w-4xl lg:max-6xl">
Â  Â  Â  Â  Â <header class="text-center mb-6 no-print">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Hybrid Time & Task Dashboard</h1>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mb-4 break-words">Session User ID: <span id="user-id-display" class="font-mono text-xs loading-text loading-shimmer rounded">Initializing user...</span></p>
Â  Â  Â  Â  Â </header>
Â  Â  Â  Â  Â <div id="login-container" class="bg-red-100 card rounded-xl p-6 mb-8 hidden">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-red-700 mb-4">Access Required</h2>
Â  Â  Â  Â  Â  Â  <p class="mb-4 text-red-600">Please sign in with your authorized Google account to use this application.</p>
Â  Â  Â  Â  Â  Â  <button id="google-sign-in-btn" onclick="handleGoogleSignIn()" class="w-full py-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition duration-200">
Â  Â  Â  Â  Â  Â  Sign In with Google
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div class="bg-white card rounded-xl p-6 mb-8 no-print">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-gray-700">Current Status (Synced)</h2>
Â  Â  Â  Â  Â  Â  <div id="status-display" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â <p class="flex justify-between items-center text-sm font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Clock Status:
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="clock-status-pill" class="status-pill bg-gray-200 text-gray-700 loading-text loading-shimmer">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â <p class="flex justify-between items-center text-sm font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Break Status:
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="break-status-pill" class="status-pill bg-gray-200 text-gray-700 loading-text loading-shimmer">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div class="bg-white card rounded-xl p-6 mb-8 flex flex-col space-y-4 no-print">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-2 text-gray-700">Quick Actions</h2>
Â  Â  Â  Â  Â  Â  <button id="clock-toggle-btn"Â 
Â  Â  Â  Â  Â  Â  Â  Â onclick="handleClockToggle()"Â 
Â  Â  Â  Â  Â  Â  Â  Â class="w-full py-3 rounded-xl font-bold text-white transition duration-200 shadow-lg hover:shadow-xl disabled:opacity-50" disabled>
Â  Â  Â  Â  Â  Â  Initializing...
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="break-toggle-btn"Â 
Â  Â  Â  Â  Â  Â  Â  Â onclick="handleBreakToggle()"Â 
Â  Â  Â  Â  Â  Â  Â  Â class="w-full py-3 rounded-xl font-bold text-gray-700 bg-yellow-400 hover:bg-yellow-500 transition duration-200 shadow-md disabled:opacity-50" disabled>
Â  Â  Â  Â  Â  Â  Initializing...
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div class="bg-indigo-700 card rounded-xl p-6 mb-8 text-white no-print">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-2">Unreported Time Summary (Synced)</h2>
Â  Â  Â  Â  Â  Â  <p id="report-since" class="text-sm opacity-75 mb-4">Last reported: <span id="last-reported-date" class="font-semibold loading-text loading-shimmer rounded">Loading date...</span></p>
Â  Â  Â  Â  Â  Â  <div class="flex flex-col space-y-2 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-center text-lg font-bold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Work Time:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="total-work-time" class="font-mono text-xl loading-text loading-shimmer rounded">00:00:00</span>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-center text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Break Time:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="total-break-time" class="font-mono loading-text loading-shimmer rounded">00:00:00</span>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="mark-reported-btn" onclick="handleMarkReported()" class="w-full bg-indigo-300 hover:bg-indigo-300 text-white font-semibold py-2 rounded-lg transition duration-150 disabled:opacity-50 no-print" disabled>
Â  Â  Â  Â  Â  Â  Mark All as Reported
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div class="bg-white card rounded-xl p-6 mb-8 no-print">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-gray-700">Priority Tasks (Synced)</h2>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mb-4">This task list is synchronized across all your devices.</p>
Â  Â  Â  Â  Â  Â  <div id="unfinished-tasks-list" class="space-y-2 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â <p class="text-center py-6 text-gray-500" id="task-loading">Awaiting database connection...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="border-t pt-4 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â <h3 class="text-lg font-semibold text-gray-700 mb-3">Add New Task</h3>
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex space-x-2 mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="new-task-text" placeholder="Task Description (e.g., Email Bob)" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="calendar-toggle-btn" onclick="handleCalendarClick()" class="flex-shrink-0 p-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150" title="Toggle Due Date">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <line x1="16" x2="16" y1="2" y2="6"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <line x1="8" x2="8" y1="2" y2="6"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <line x1="3" x2="21" y1="10" y2="10"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-task-btn" onclick="handleAddTask()" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 disabled:opacity-50" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Add
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div id="due-date-container" class="mt-3 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-due-date" class="text-sm font-medium text-gray-600">Select Due Date (Optional):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="new-due-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â </div>
<div id="log-report-container" class="bg-white card rounded-xl p-6 mb-8">
Â  Â Â 
Â  Â  <div class="mb-2 no-print">Â 
Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-700"><span id="log-view-title">Time Log Segments (For Reporting)</span></h2>
Â  Â  </div>

Â  Â  <div class="flex space-x-2 mb-4 no-print">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="manage-logs-btn" onclick="handleLogViewToggle()" class="no-print bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-150" title="Edit or Delete individual event logs">
Â  Â  Â  Â  Â  Â  Manage Log Events
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="download-csv-btn" onclick="syncRawLogsToSheet()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="no-print bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold p-3 rounded-xl transition duration-150"Â 
Â  Â  Â  Â  Â  Â  Â  Â  title="Download Full Log History as CSV"Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
Â  Â  Â  Â  Â  Â  Â  Â  <polyline points="7 10 12 15 17 10"/>
Â  Â  Â  Â  Â  Â  Â  Â  <line x1="12" y1="15" x2="12" y2="3"/>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="print-report-btn" onclick="handlePrintReport()" class="no-print bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-150 disabled:opacity-50" disabled>
Â  Â  Â  Â  Â  Â  Print Report
Â  Â  Â  Â  </button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="log-history-list" class="space-y-2 text-sm max-h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
Â  Â  Â  Â  <p class="text-center py-4 text-gray-500" id="history-loading">Awaiting session data...</p>
Â  Â  </div>
Â  Â  <p id="log-footer-text" class="text-xs text-gray-500 mt-4 text-center no-print">Calculated time spans since the last report cutoff.</p>
</div>
Â  Â  Â  Â  Â <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
Â  Â  Â  Â  Â  Â  Â  Â <h3 id="message-title" class="text-xl font-bold mb-3 text-red-600">Alert</h3>
Â  Â  Â  Â  Â  Â  Â  Â <p id="message-content" class="text-gray-700 mb-4"></p>
Â  Â  Â  Â  Â  Â  Â  Â <button onclick="hideMessage()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â OK
Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div id="editLogModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
Â  Â  Â  Â  Â  Â  Â  Â <h3 class="text-2xl font-bold mb-4 text-gray-800">Edit Log Event</h3>
Â  Â  Â  Â  Â  Â  Â  Â <p class="text-sm text-gray-600 mb-4">Adjust the timestamp for the selected event. This will automatically recalculate all reports.</p>
Â  Â  Â  Â  Â  Â  Â  Â <input type="hidden" id="editingLogId">
Â  Â  Â  Â  Â  Â  Â  Â <p class="font-semibold mb-2">Event Type: <span id="editingLogType" class="text-indigo-600"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="editDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editTime" class="block text-sm font-medium text-gray-700 mb-1">Time (24-hour format, HH:MM)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="editTime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="hideEditModal()" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Cancel
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="handleSaveEdit()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Save Changes
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  </div>
Â  Â  Â  <script type="module">
Â  Â  Â  Â  Â // --- IMMEDIATE VIEWPORT FIX ---
Â  Â  Â  Â  Â (function() {
Â  Â  Â  Â  Â  Â  Â // 1. Force remove any existing viewport tag
Â  Â  Â  Â  Â  Â  Â const metaTags = document.head.getElementsByTagName('meta');
Â  Â  Â  Â  Â  Â  Â for (let i = metaTags.length - 1; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (metaTags[i].name === 'viewport') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.head.removeChild(metaTags[i]);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 2. Create the robust viewport tag and inject it
Â  Â  Â  Â  Â  Â  Â const newMeta = document.createElement('meta');
Â  Â  Â  Â  Â  Â  Â newMeta.name = 'viewport';
Â  Â  Â  Â  Â  Â  Â // Explicitly set width to device-width and prevent scaling
Â  Â  Â  Â  Â  Â  Â newMeta.content = 'width=device-width, initial-scale=1.0';
Â  Â  Â  Â  Â  Â  Â document.head.appendChild(newMeta);
Â  Â  Â  Â  Â })();Â 
Â  Â  Â  Â  Â // -----------------------------
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- INJECTED FIREBASE CONFIGURATION (Original, Unchanged) ---
Â  Â  Â  Â  Â const __app_id = '1:271808577978:web:c2e0f745681401fe4f1d83';
Â  Â  Â  Â  Â const __firebase_config = '{"apiKey":"AIzaSyAGxZVLaHkowzF5ioMGGS9FnqMh31Zs5ds","authDomain":"timeclockapp-59694.firebaseapp.com","projectId":"timeclockapp-59694","storageBucket":"timeclockapp-59694.appspot.com","messagingSenderId":"271808577978","appId":"1:271808577978:web:c2e0f745681401fe4f1d83","measurementId":"G-6C1MRRFZTB"}';
Â  Â  Â  Â  Â const __initial_auth_token = "";Â 
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Firebase Imports ---
Â  Â  Â  Â  Â import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {Â 
Â  Â  getAuth,Â 
Â  Â  GoogleAuthProvider,Â 
Â  Â  signInWithPopup,Â  Â Â 
Â  Â  onAuthStateChanged,Â 
Â  Â  setPersistence,Â 
Â  Â  browserLocalPersistenceÂ 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, query, orderBy, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
Â  Â  Â  Â  Â // --- State and Constants ---
Â  Â  Â  Â  Â let db;
Â  Â  Â  Â  Â let auth;
Â  Â  Â  Â  Â let userId = null;
Â  Â  Â  Â  Â const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â  Â  Â  Â  Â const firebaseConfig = JSON.parse(__firebase_config);
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â let currentState = {
Â  Â  Â  Â  Â  Â  Â isClockedIn: false,
Â  Â  Â  Â  Â  Â  Â isUserOnBreak: false,
Â  Â  Â  Â  Â  Â  Â tasks: [],Â 
Â  Â  Â  Â  Â  Â  Â lastReportTimestamp: nullÂ 
Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â let currentReportData = {Â 
Â  Â  Â  Â  Â  Â  Â segments: [],Â 
Â  Â  Â  Â  Â  Â  Â totalWorkTime: '00:00:00',Â 
Â  Â  Â  Â  Â  Â  Â totalBreakTime: '00:00:00',
Â  Â  Â  Â  Â  Â  Â reportStartDate: new Date(),Â 
Â  Â  Â  Â  Â  Â  Â reportEndDate: new Date()Â 
Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // NEW STATE: Stores the raw log events (with IDs) and controls the log view
Â  Â  Â  Â  Â let rawLogEvents = [];
Â  Â  Â  Â  Â let isManagingLogs = false; // False = show report segments, True = show raw events
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â let showDatePicker = false;
Â  Â  Â  Â  Â let newDueDate = null; // Stored as YYYY-MM-DD string
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- DOM Elements (Same as before) ---
Â  Â  Â  Â  Â const clockToggleBtn = document.getElementById('clock-toggle-btn');
Â  Â  Â  Â  Â const breakToggleBtn = document.getElementById('break-toggle-btn');
Â  Â  Â  Â  Â const clockStatusPill = document.getElementById('clock-status-pill');
Â  Â  Â  Â  Â const breakStatusPill = document.getElementById('break-status-pill');
Â  Â  Â  Â  Â const tasksListEl = document.getElementById('unfinished-tasks-list');
Â  Â  Â  Â  Â const taskLoadingEl = document.getElementById('task-loading');
Â  Â  Â  Â  Â const userIdDisplayEl = document.getElementById('user-id-display');
Â  Â  Â  Â  Â const logHistoryListEl = document.getElementById('log-history-list');Â 
Â  Â  Â  Â  Â const historyLoadingEl = document.getElementById('history-loading');Â 
Â  Â  Â  Â  Â const printReportBtn = document.getElementById('print-report-btn');
Â  Â  Â  Â  Â const totalWorkTimeEl = document.getElementById('total-work-time');Â 
Â  Â  Â  Â  Â const totalBreakTimeEl = document.getElementById('total-break-time');Â 
Â  Â  Â  Â  Â const lastReportedDateEl = document.getElementById('last-reported-date');Â 
Â  Â  Â  Â  Â const markReportedBtn = document.getElementById('mark-reported-btn');Â 
Â  Â  Â  Â  Â const newTaskTextEl = document.getElementById('new-task-text');
Â  Â  Â  Â  Â const addTaskBtn = document.getElementById('add-task-btn');
Â  Â  Â  Â  Â const dueDateContainerEl = document.getElementById('due-date-container');
Â  Â  Â  Â  Â const newDueDateEl = document.getElementById('new-due-date');
Â  Â  Â  Â  Â const logViewTitleEl = document.getElementById('log-view-title');
Â  Â  Â  Â  Â const logFooterTextEl = document.getElementById('log-footer-text');
Â  Â  Â  Â  Â const manageLogsBtn = document.getElementById('manage-logs-btn');
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // Edit Modal Elements
Â  Â  Â  Â  Â const editLogModal = document.getElementById('editLogModal');
Â  Â  Â  Â  Â const editingLogIdEl = document.getElementById('editingLogId');
Â  Â  Â  Â  Â const editingLogTypeEl = document.getElementById('editingLogType');
Â  Â  Â  Â  Â const editDateEl = document.getElementById('editDate');
Â  Â  Â  Â  Â const editTimeEl = document.getElementById('editTime');
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â newDueDateEl.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â newDueDate = e.target.value;
Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Utility & UI Functions ---
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â /**
Â  Â  Â  Â  Â  * Converts milliseconds to HH:MM:SS format.
Â  Â  Â  Â  Â  * IMPORTANT: Ensures the output is always positive.
Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â function msToHours(ms) {
Â  Â  Â  Â  Â  Â  Â // Use absolute value to prevent negative display time in summary
Â  Â  Â  Â  Â  Â  Â const totalMs = Math.abs(ms);Â 
Â  Â  Â  Â  Â  Â  Â const totalSeconds = Math.floor(totalMs / 1000);
Â  Â  Â  Â  Â  Â  Â const hours = Math.floor(totalSeconds / 3600);
Â  Â  Â  Â  Â  Â  Â const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  Â const seconds = totalSeconds % 60;
Â  Â  Â  Â  Â  Â  Â return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function renderReportSummary(workTime, breakTime) {
Â  Â  Â  Â  Â  Â  Â totalWorkTimeEl.textContent = workTime;
Â  Â  Â  Â  Â  Â  Â totalBreakTimeEl.textContent = breakTime;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const ts = currentState.lastReportTimestamp;
Â  Â  Â  Â  Â  Â  Â if (ts) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const date = new Date(ts).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
Â  Â  Â  Â  Â  Â  Â  Â  Â lastReportedDateEl.textContent = date;
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â lastReportedDateEl.textContent = 'Never (Showing All Time)';
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â // Remove loading placeholders once data is available
Â  Â  Â  Â  Â  Â  Â totalWorkTimeEl.classList.remove('loading-text', 'loading-shimmer');
Â  Â  Â  Â  Â  Â  Â totalBreakTimeEl.classList.remove('loading-text', 'loading-shimmer');
Â  Â  Â  Â  Â  Â  Â lastReportedDateEl.classList.remove('loading-text', 'loading-shimmer');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function showMessage(title, content, isError = false) {
Â  Â  Â  Â  Â  Â  Â const box = document.getElementById('message-box');
Â  Â  Â  Â  Â  Â  Â const titleEl = document.getElementById('message-title');
Â  Â  Â  Â  Â  Â  Â const contentEl = document.getElementById('message-content');
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â titleEl.textContent = title;
Â  Â  Â  Â  Â  Â  Â contentEl.textContent = content;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â titleEl.className = `text-xl font-bold mb-3 ${isError ? 'text-red-600' : 'text-green-600'}`;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â box.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â box.classList.add('flex');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.hideMessage = function() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('message-box').classList.remove('flex');
Â  Â  Â  Â  Â  Â  Â document.getElementById('message-box').classList.add('hidden');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.hideEditModal = function() {
Â  Â  Â  Â  Â  Â  Â editLogModal.classList.remove('flex');
Â  Â  Â  Â  Â  Â  Â editLogModal.classList.add('hidden');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function renderStatus() {
Â  Â  Â  Â  Â  Â  Â // Update UI based on currentState
Â  Â  Â  Â  Â  Â  Â // Clock Status Pill
Â  Â  Â  Â  Â  Â  Â if (currentState.isClockedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â clockStatusPill.textContent = 'CLOCKED IN';
Â  Â  Â  Â  Â  Â  Â  Â  Â clockStatusPill.className = 'status-pill bg-green-100 text-green-700';
Â  Â  Â  Â  Â  Â  Â  Â  Â clockToggleBtn.textContent = 'Clock OUT';
Â  Â  Â  Â  Â  Â  Â  Â  Â clockToggleBtn.className = 'w-full py-3 rounded-xl font-bold text-white transition duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 bg-red-600 hover:bg-red-700';
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â clockStatusPill.textContent = 'CLOCKED OUT';
Â  Â  Â  Â  Â  Â  Â  Â  Â clockStatusPill.className = 'status-pill bg-red-100 text-red-700';
Â  Â  Â  Â  Â  Â  Â  Â  Â clockToggleBtn.textContent = 'Clock IN';
Â  Â  Â  Â  Â  Â  Â  Â  Â clockToggleBtn.className = 'w-full py-3 rounded-xl font-bold text-white transition duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 bg-green-600 hover:bg-green-700';
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Break Status Pill & Button
Â  Â  Â  Â  Â  Â  Â if (currentState.isUserOnBreak) {
Â  Â  Â  Â  Â  Â  Â  Â  Â breakStatusPill.textContent = 'ON BREAK';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakStatusPill.className = 'status-pill bg-yellow-100 text-amber-700';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakToggleBtn.textContent = 'Break END';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakToggleBtn.className = 'w-full py-3 rounded-xl font-bold text-gray-700 bg-yellow-400 hover:bg-yellow-500 transition duration-200 shadow-md disabled:opacity-50';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakToggleBtn.disabled = !currentState.isClockedIn;
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â breakStatusPill.textContent = 'WORKING';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakStatusPill.className = 'status-pill bg-indigo-100 text-indigo-700';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakToggleBtn.textContent = 'Break START';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakToggleBtn.className = 'w-full py-3 rounded-xl font-bold text-gray-700 bg-yellow-400 hover:bg-yellow-500 transition duration-200 shadow-md disabled:opacity-50';
Â  Â  Â  Â  Â  Â  Â  Â  Â breakToggleBtn.disabled = !currentState.isClockedIn;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
// ========================================
// NEW VERSION (Mobile & Desktop Optimized)
// ========================================
function renderTasks() {
Â  Â  tasksListEl.innerHTML = '';

Â  Â  // --- 1. Date Filtering Logic ---
Â  Â  const now = new Date();
Â  Â  now.setHours(0, 0, 0, 0); // Set to start of today
Â  Â  const twoWeeksFromNow = new Date(now);
Â  Â  twoWeeksFromNow.setDate(twoWeeksFromNow.getDate() + 14);

Â  Â  console.log('Today:', now);
Â  Â  console.log('Two weeks from now:', twoWeeksFromNow);

Â  Â  const filteredTasks = currentState.tasks.filter(task => {
Â  Â  Â  Â  if (!task.dueDate) return true; // Show tasks with no due date
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ensure due date is compared at the start of the day
Â  Â  Â  Â  const dueDate = new Date(task.dueDate + 'T00:00:00');
Â  Â  Â  Â  dueDate.setHours(0, 0, 0, 0); // Normalize to start of day

Â  Â  Â  Â  console.log('Task:', task.text, 'Due:', dueDate, 'In range?', (dueDate >= now && dueDate <= twoWeeksFromNow));

Â  Â  Â  Â  // Show only if due between today (inclusive) and 2 weeks from now (inclusive)
Â  Â  Â  Â  return dueDate >= now && dueDate <= twoWeeksFromNow;Â 
Â  Â  });

Â  Â  // --- 2. Sorting Logic ---
Â  Â  filteredTasks.sort((a, b) => {
Â  Â  Â  Â  // Completed tasks go to the bottom
Â  Â  Â  Â  if (a.isCompleted !== b.isCompleted) {
Â  Â  Â  Â  Â  Â  return a.isCompleted ? 1 : -1;
Â  Â  Â  Â  }
Â  Â  Â  Â  // Otherwise, sort by creation time (newest first)
Â  Â  Â  Â  const timeA = a.createdAt?.seconds ? a.createdAt.seconds * 1000 : new Date().getTime();
Â  Â  Â  Â  const timeB = b.createdAt?.seconds ? b.createdAt.seconds * 1000 : new Date().getTime();
Â  Â  Â  Â  return timeB - timeA;
Â  Â  });

Â  Â  // --- 3. Empty State Check ---
Â  Â  if (filteredTasks.length === 0) {
Â  Â  Â  Â  // âœ… Responsive text size (text-sm)
Â  Â  Â  Â  tasksListEl.innerHTML = '<p class="text-center py-4 text-gray-500 text-sm">No tasks due in the next two weeks.</p>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // --- 4. Rendering the Filtered Tasks ---
Â  Â  // ðŸ‘‡ CRUCIAL FIX: Loop over the filteredTasks array
Â  Â  filteredTasks.forEach((task) => {Â 
Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  const completed = task.isCompleted;

Â  Â  Â  Â  // --- Item Styling ---
Â  Â  Â  Â  const itemClasses = completed
Â  Â  Â  Â  Â  Â  // âœ… items-start: aligns items at top, works better when buttons stack
Â  Â  Â  Â  Â  Â  ? 'task-item bg-gray-200 rounded-lg flex items-start border-green-500 p-4 mb-3 shadow-sm'
Â  Â  Â  Â  Â  Â  : 'task-item bg-white hover:bg-indigo-50 rounded-lg flex items-start border-indigo-500 p-4 mb-3 shadow-md';

Â  Â  Â  Â  item.className = itemClasses;

Â  Â  Â  Â  // --- Text Container (Task Text, Due Date, Creator) ---
Â  Â  Â  Â  const textContainer = document.createElement('div');
Â  Â  Â  Â  textContainer.className = 'flex-grow mr-2 sm:mr-4 min-w-0';

Â  Â  Â  Â  const textSpan = document.createElement('span');
Â  Â  Â  Â  // ðŸ‘‡ MAIN TASK TEXT: text-lg on mobile, text-lg on screens >= sm
Â  Â  Â  Â  textSpan.className = `text-lg sm:text-lg font-medium break-words ${completed ? 'text-gray-600 line-through' : 'text-gray-800'}`;
Â  Â  Â  Â  textSpan.textContent = task.text;
Â  Â  Â  Â  textContainer.appendChild(textSpan);

Â  Â  Â  Â  if (task.dueDate) {
Â  Â  Â  Â  Â  Â  const dueDateSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  const dateObj = new Date(task.dueDate + 'T00:00:00');
Â  Â  Â  Â  Â  Â  // ðŸ‘‡ DUE DATE: text-base on mobile
Â  Â  Â  Â  Â  Â  dueDateSpan.className = `text-base mt-1 font-semibold block ${completed ? 'text-gray-400' : 'text-orange-500'}`;
Â  Â  Â  Â  Â  Â  dueDateSpan.textContent = `Due: ${dateObj.toLocaleDateString()}`;
Â  Â  Â  Â  Â  Â  textContainer.appendChild(dueDateSpan);
Â  Â  Â  Â  }

Â  Â  Â  Â  const creatorInfo = document.createElement('div');
Â  Â  Â  Â  // ðŸ‘‡ CREATOR INFO: Explicitly set to the smallest size (text-xs)
Â  Â  Â  Â  creatorInfo.className = 'text-xs mt-0.5 text-gray-500';
Â  Â  Â  Â  creatorInfo.textContent = `By: ${task.ownerId ? task.ownerId.substring(0, 8) + '...' : 'Unknown'}`;
Â  Â  Â  Â  textContainer.appendChild(creatorInfo);

Â  Â  Â  Â  // --- Button Container ---
Â  Â  Â  Â  const buttonContainer = document.createElement('div');
Â  Â  Â  Â  // âœ… Buttons side-by-side on all screens. Removed flex-col/flex-row toggle for simplicity/modern UI.
Â  Â  Â  Â  buttonContainer.className = 'flex-shrink-0 flex flex-row space-x-2 w-full sm:w-auto justify-end mt-2 sm:mt-0';

Â  Â  Â  Â  // --- Complete Button ---
Â  Â  Â  Â  const completeBtn = document.createElement('button');
Â  Â  Â  Â  // âœ… active:scale-95 for touch feedback
Â  Â  Â  Â  completeBtn.className = `w-3/5 text-white text-base font-semibold px-2 sm:px-3 py-1.5 sm:py-1 rounded-full transition duration-150 shadow-md active:scale-95 ${completed ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'}`;
Â  Â  Â  Â  completeBtn.textContent = completed ? 'Undo' : ' âœ”ï¸ Done ';
Â  Â  Â  Â  // Retain functionality
Â  Â  Â  Â  completeBtn.onclick = () => toggleTaskCompletion(task.id, task.isCompleted);

Â  Â  Â  Â  // --- Delete Button ---
Â  Â  Â  Â  const deleteBtn = document.createElement('button');
Â  Â  Â  Â  // âœ… active:scale-95 for touch feedback
Â  Â  Â  Â  deleteBtn.className = 'w-2/5 text-white text-xs font-semibold px-2 sm:px-3 py-1.5 sm:py-1 rounded-full bg-red-500 hover:bg-red-600 transition duration-150 shadow-md active:scale-95';
Â  Â  Â  Â  deleteBtn.textContent = ' ð˜Ÿ ';
Â  Â  Â  Â  // Retain functionality
Â  Â  Â  Â  deleteBtn.onclick = () => deleteTask(task.id);

Â  Â  Â  Â  buttonContainer.appendChild(completeBtn);
Â  Â  Â  Â  buttonContainer.appendChild(deleteBtn);

Â  Â  Â  Â  // --- Final Assembly ---
Â  Â  Â  Â  item.appendChild(textContainer);
Â  Â  Â  Â  item.appendChild(buttonContainer);
Â  Â  Â  Â  tasksListEl.appendChild(item);
Â  Â  });
}Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â /**
Â  Â  Â  Â  Â  * Calculates total time and generates segments (spans) of work/break.
Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â function calculateReportData(logs, sinceTimestamp) {
Â  Â  Â  Â  Â  Â  Â let totalWorkMs = 0;
Â  Â  Â  Â  Â  Â  Â let totalBreakMs = 0;
Â  Â  Â  Â  Â  Â  Â let workStart = null;
Â  Â  Â  Â  Â  Â  Â let breakStart = null;
Â  Â  Â  Â  Â  Â  Â const segments = [];
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const filterCutoffMs = sinceTimestamp ? new Date(sinceTimestamp).getTime() : 0;
Â  Â  Â  Â  Â  Â  Â // Filter logs to only include those that occurred *after* the last report timestamp
Â  Â  Â  Â  Â  Â  Â const filteredLogs = logs.filter(log => new Date(log.timestamp).getTime() > filterCutoffMs);
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Sort ascending by timestamp to process events chronologically
Â  Â  Â  Â  Â  Â  Â filteredLogs.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 1. Process historical logs and generate segments
Â  Â  Â  Â  Â  Â  Â filteredLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const timestamp = new Date(log.timestamp).getTime();
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â switch (log.type) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â case 'CLOCK_IN':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (breakStart !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const duration = timestamp - breakStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'BREAK', start: new Date(breakStart), end: new Date(timestamp), durationMs: duration });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalBreakMs += duration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â breakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (workStart === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â workStart = timestamp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â case 'BREAK_START':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (workStart !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const duration = timestamp - workStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'WORK', start: new Date(workStart), end: new Date(timestamp), durationMs: duration });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalWorkMs += duration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â workStart = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (breakStart === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â breakStart = timestamp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â case 'BREAK_END':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (breakStart !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const duration = timestamp - breakStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'BREAK', start: new Date(breakStart), end: new Date(timestamp), durationMs: duration });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalBreakMs += duration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â breakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (workStart === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â workStart = timestamp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â case 'CLOCK_OUT':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (workStart !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const duration = timestamp - workStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'WORK', start: new Date(workStart), end: new Date(timestamp), durationMs: duration });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalWorkMs += duration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â workStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (breakStart !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const duration = timestamp - breakStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'BREAK', start: new Date(breakStart), end: new Date(timestamp), durationMs: duration });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalBreakMs += duration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â breakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 2. Add current active segment (if clocked in)
Â  Â  Â  Â  Â  Â  Â if (currentState.isClockedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  Â const nowMs = now.getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Only consider segments that started *after* the report cutoff
Â  Â  Â  Â  Â  Â  Â  Â  Â if (currentState.isUserOnBreak && breakStart !== null && breakStart > filterCutoffMs) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const durationMs = nowMs - breakStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'BREAK', start: new Date(breakStart), end: now, durationMs: durationMs, isLive: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalBreakMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (workStart !== null && workStart > filterCutoffMs) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const durationMs = nowMs - workStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â segments.push({ type: 'WORK', start: new Date(workStart), end: now, durationMs: durationMs, isLive: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalWorkMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Determine report dates for the title
Â  Â  Â  Â  Â  Â  Â const startDate = filteredLogs.length > 0 ? new Date(filteredLogs[0].timestamp) : new Date();
Â  Â  Â  Â  Â  Â  Â const endDate = new Date(); // Always current date
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Sort segments by start time for the report view
Â  Â  Â  Â  Â  Â  Â segments.sort((a, b) => a.start.getTime() - b.start.getTime());
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â return {
Â  Â  Â  Â  Â  Â  Â  Â  Â totalWorkTimeMs: totalWorkMs,
Â  Â  Â  Â  Â  Â  Â  Â  Â totalBreakTimeMs: totalBreakMs,
Â  Â  Â  Â  Â  Â  Â  Â  Â segments: segments,
Â  Â  Â  Â  Â  Â  Â  Â  Â reportStartDate: startDate,
Â  Â  Â  Â  Â  Â  Â  Â  Â reportEndDate: endDate
Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â /**
Â  Â  Â  Â  Â  * Renders the raw log events for editing/deletion.
Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â function renderRawLogEvents() {
Â  Â  Â  Â  Â  Â  Â logHistoryListEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (rawLogEvents.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â logHistoryListEl.innerHTML = '<p class="text-center py-4 text-gray-500">No time log events found.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Sort descending by timestamp (most recent first)
Â  Â  Â  Â  Â  Â  Â const sortedLogs = [...rawLogEvents].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const table = document.createElement('table');
Â  Â  Â  Â  Â  Â  Â table.className = 'print-table text-left w-full text-sm';
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â table.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <thead class="bg-red-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2">Event Type</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2">Timestamp</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2 text-right">Actions</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â </tbody>
Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â const tbody = table.querySelector('tbody');
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â sortedLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const row = tbody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const logTime = new Date(log.timestamp);
Â  Â  Â  Â  Â  Â  Â  Â  Â const dateText = logTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  Â const timeText = logTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 font-semibold">${log.type}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 text-gray-600">${dateText} at ${timeText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 text-right space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="handleEditEvent('${log.id}', '${log.type}', '${log.timestamp}')" class="text-xs bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="handleDeleteEvent('${log.id}', '${log.type}')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">Delete</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â logHistoryListEl.appendChild(table);
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â /**
Â  Â  Â  Â  Â  * Renders the calculated time log segments (the report view).
Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â function renderTimeLogSegments(segments, totalWorkTimeMs, totalBreakTimeMs) {
Â  Â  Â  Â  Â  Â  Â logHistoryListEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Format dates for the title (e.g., Nov 26, 26)
Â  Â  Â  Â  Â  Â  Â const dateOptions = { month: 'short', day: 'numeric', year: 'numeric' };
Â  Â  Â  Â  Â  Â  Â const startDateFormatted = currentReportData.reportStartDate.toLocaleDateString('en-US', dateOptions);
Â  Â  Â  Â  Â  Â  Â const endDateFormatted = currentReportData.reportEndDate.toLocaleDateString('en-US', dateOptions);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // CALCULATE THE FINAL DISPLAY TOTAL by subtracting break time from work time
Â  Â  Â  Â  Â  Â  Â const netWorkMs = totalWorkTimeMs - totalBreakTimeMs;
Â  Â  Â  Â  Â  Â  Â const netWorkTimeFormatted = msToHours(netWorkMs); // Format the final value
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // --- 1. Print Header (CORRECTED STRUCTURE) ---
Â  Â  Â  Â  Â  Â  Â const printHeaderContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â // This class is targeted by the @media print CSS to be DISPLAYED.
Â  Â  Â  Â  Â  Â  Â printHeaderContainer.className = 'print-header hidden';Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â printHeaderContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <h1 class="text-xl font-bold mb-1">Time Log Report (${startDateFormatted} - ${endDateFormatted})</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-sm">Rosemary E. Pyles</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-sm font-bold mt-2">TOTAL WORKED: ${netWorkTimeFormatted}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-xs">Reported Since: ${lastReportedDateEl.textContent}</p>
Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â // Insert the header at the top of the report list container
Â  Â  Â  Â  Â  Â  Â logHistoryListEl.prepend(printHeaderContainer);Â 
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // --- 2. Segment Table ---
Â  Â  Â  Â  Â  Â  Â if (segments.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const p = document.createElement('p');
Â  Â  Â  Â  Â  Â  Â  Â  Â p.className = 'text-center py-4 text-gray-500';
Â  Â  Â  Â  Â  Â  Â  Â  Â p.textContent = 'No new time segments found since the last report.';
Â  Â  Â  Â  Â  Â  Â  Â  Â logHistoryListEl.appendChild(p);
Â  Â  Â  Â  Â  Â  Â  Â  Â // Also update the UI summary to 00:00:00 if no data
Â  Â  Â  Â  Â  Â  Â  Â  Â renderReportSummary('00:00:00', '00:00:00');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const table = document.createElement('table');
Â  Â  Â  Â  Â  Â  Â table.className = 'print-table text-left w-full text-sm';
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // ðŸ›‘ FIX: Removed 'Activity' header column
Â  Â  Â  Â  Â  Â  Â table.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <thead class="bg-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2">Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2">Start Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2">End Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <th class="p-2 text-right">Duration</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â </tbody>
Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â const tbody = table.querySelector('tbody');
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â segments.forEach(segment => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const row = tbody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  Â const date = segment.start.toLocaleDateString('en-US', dateOptions);
Â  Â  Â  Â  Â  Â  Â  Â  Â const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
Â  Â  Â  Â  Â  Â  Â  Â  Â const startTime = segment.start.toLocaleTimeString('en-US', timeOptions);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Use 'LIVE' or formatted time for end time
Â  Â  Â  Â  Â  Â  Â  Â  Â const endTime = segment.isLiveÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ? '<span class="text-indigo-500 font-semibold">LIVE</span>'Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : segment.end.toLocaleTimeString('en-US', timeOptions);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const durationText = msToHours(segment.durationMs);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â let activityText; // Still calculated, but not displayed in print/report view
Â  Â  Â  Â  Â  Â  Â  Â  Â let colorClass;
Â  Â  Â  Â  Â  Â  Â  Â  Â let durationDisplay;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (segment.type === 'WORK') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â activityText = 'Work';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â colorClass = 'text-green-600';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â durationDisplay = `<span class="font-bold">${durationText}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â } else { // BREAK
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â activityText = 'Break';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â colorClass = 'text-red-600';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Display break time in parentheses
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â durationDisplay = `<span class="font-bold text-red-600">(${durationText})</span>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Check for negative duration (which can happen with inconsistent logs)
Â  Â  Â  Â  Â  Â  Â  Â  Â if (segment.durationMs < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  durationDisplay = `<span class="font-bold text-red-700">TIME CONFLICT!</span>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.classList.add('bg-red-100'); // Highlight the error row
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // ðŸ›‘ FIX: Removed 'Activity' data cell. Now only 4 columns.
Â  Â  Â  Â  Â  Â  Â  Â  Â row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 text-gray-700">${date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 text-gray-600">${startTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 text-gray-600">${endTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="p-2 text-right">${durationDisplay}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â logHistoryListEl.appendChild(table);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 3. Update the UI summary totals using the calculated raw milliseconds
Â  Â  Â  Â  Â  Â  Â renderReportSummary(netWorkTimeFormatted, msToHours(totalWorkTimeMs));
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Render Main Log View based on isManagingLogs state ---
Â  Â  Â  Â  Â function renderMainLogView() {
Â  Â  Â  Â  Â  Â  Â if (isManagingLogs) {
Â  Â  Â  Â  Â  Â  Â  Â  Â logViewTitleEl.textContent = 'Raw Log Events (Edit/Delete)';
Â  Â  Â  Â  Â  Â  Â  Â  Â logFooterTextEl.textContent = 'Correcting these timestamps will automatically update the report.';
Â  Â  Â  Â  Â  Â  Â  Â  Â manageLogsBtn.textContent = 'View Report Segments';
Â  Â  Â  Â  Â  Â  Â  Â  Â renderRawLogEvents();
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â logViewTitleEl.textContent = 'Time Log Segments (For Reporting)';
Â  Â  Â  Â  Â  Â  Â  Â  Â logFooterTextEl.textContent = 'Calculated time spans since the last report cutoff.';
Â  Â  Â  Â  Â  Â  Â  Â  Â manageLogsBtn.textContent = 'Manage Log Events';
Â  Â  Â  Â  Â  Â  Â  Â  Â renderTimeLogSegments(currentReportData.segments, currentReportData.totalWorkTimeMs, currentReportData.totalBreakTimeMs);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Log Management Handlers ---
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleLogViewToggle = function() {
Â  Â  Â  Â  Â  Â  Â isManagingLogs = !isManagingLogs;
Â  Â  Â  Â  Â  Â  Â renderMainLogView();
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleEditEvent = function(logId, logType, logTimestamp) {
Â  Â  Â  Â  Â  Â  Â const date = new Date(logTimestamp);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Format date to YYYY-MM-DD
Â  Â  Â  Â  Â  Â  Â const year = date.getFullYear();
Â  Â  Â  Â  Â  Â  Â const month = String(date.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â const day = String(date.getDate()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â const dateValue = `${year}-${month}-${day}`;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Format time to HH:MM (24-hour)
Â  Â  Â  Â  Â  Â  Â const hours = String(date.getHours()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â const minutes = String(date.getMinutes()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â const timeValue = `${hours}:${minutes}`;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Populate the modal
Â  Â  Â  Â  Â  Â  Â editingLogIdEl.value = logId;
Â  Â  Â  Â  Â  Â  Â editingLogTypeEl.textContent = logType;
Â  Â  Â  Â  Â  Â  Â editDateEl.value = dateValue;
Â  Â  Â  Â  Â  Â  Â editTimeEl.value = timeValue;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Show the modal
Â  Â  Â  Â  Â  Â  Â editLogModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â editLogModal.classList.add('flex');
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleSaveEdit = async function() {
Â  Â  Â  Â  Â  Â  Â const logId = editingLogIdEl.value;
Â  Â  Â  Â  Â  Â  Â const newDateStr = editDateEl.value;
Â  Â  Â  Â  Â  Â  Â const newTimeStr = editTimeEl.value;
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (!logId || !newDateStr || !newTimeStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Input Error", "Please select both a valid date and time.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Combine date and time to create a new timestamp
Â  Â  Â  Â  Â  Â  Â const newTimestampISO = new Date(`${newDateStr}T${newTimeStr}:00`).toISOString();
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â hideEditModal();
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const logRef = doc(db, getTimeLogCollectionRef().path, logId);
Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(logRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â timestamp: newTimestampISO
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Log Updated", `Successfully updated log event ID: ${logId.substring(0, 8)}...`, false);
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error updating log event:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Update Failed", `Failed to update log event. Error: ${e.message}`, true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 

	window.handleDeleteEvent = async function(logId, logType) { // ðŸŸ¢ FIX: logType must be defined here
Â  Â  // The alert uses logType to confirm the deletion (prevents the ReferenceError)
Â  Â  if (!confirm(`Are you sure you want to delete the ${logType} event (ID: ${logId.substring(0, 8)}...)? This action cannot be undone and will affect your reports.`)) {
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const logRef = doc(db, getTimeLogCollectionRef().path, logId);
Â  Â  Â  Â  await deleteDoc(logRef);
Â  Â  Â  Â  // Uses the logType argument for the success message
Â  Â  Â  Â  showMessage("Log Deleted", `Successfully deleted log event: ${logType}`, false);Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error deleting log event:", e);
Â  Â  Â  Â  showMessage("Delete Failed", `Failed to delete log event. Error: ${e.message}`, true);
Â  Â  }
}
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Firestore Path Functions (ALL PUBLIC/SHARED) ---
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function getReportStateRef() {
Â  Â  Â  Â  Â  Â  Â const docPath = `artifacts/${appId}/public/data/state/report_cutoff`;
Â  Â  Â  Â  Â  Â  Â return doc(db, docPath);
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function getTimeLogCollectionRef() {
Â  Â  Â  Â  Â  Â  Â const collectionPath = `artifacts/${appId}/public/data/timeLogs`;
Â  Â  Â  Â  Â  Â  Â return collection(db, collectionPath);
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function getClockStateRef() {
Â  Â  Â  Â  Â  Â  Â const docPath = `artifacts/${appId}/public/data/state/clock_status`;
Â  Â  Â  Â  Â  Â  Â return doc(db, docPath);
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â function getPublicTasksCollectionRef() {
Â  Â  Â  Â  Â  Â  Â const collectionPath = `artifacts/${appId}/public/data/tasks`;
Â  Â  Â  Â  Â  Â  Â return collection(db, collectionPath);
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â async function logTimeEvent(type) {
Â  Â  Â  Â  Â  Â  Â  if (!db || !userId) return;
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const logRef = getTimeLogCollectionRef();
Â  Â  Â  Â  Â  Â  Â  Â  Â await addDoc(logRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â type: type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â timestamp: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error logging time event:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Log Error", `Failed to record ${type} event.`, true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â /**
Â  Â  Â  Â  Â  * Sends the final report data to the Apps Script backend.
Â  Â  Â  Â  Â  * NOTE: This function requires the HTML to be served as a GAS Web App.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â function sendReportDataToServer(reportData, timestamp) {
Â  Â  Â  Â  Â  if (typeof google === 'undefined' || !google.script || !google.script.run) {
Â  Â  Â  Â  Â  Â  showMessage("Error", "Google Apps Script API not available. Cannot sync report.", true);
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â const netWorkMs = reportData.totalWorkTimeMs - reportData.totalBreakTimeMs;
Â  Â  Â  Â  Â  Â const netWorkTimeFormatted = msToHours(netWorkMs);
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â const dataToSend = {
Â  Â  Â  Â  Â  Â  Â  Â cutoffTimestamp: timestamp,
Â  Â  Â  Â  Â  Â  Â  Â totalWorkHours: netWorkTimeFormatted,
Â  Â  Â  Â  Â  Â  Â  Â totalBreakHours: msToHours(reportData.totalBreakTimeMs)
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // Call the backend GAS function
Â  Â  Â  Â  Â  Â google.script.run
Â  Â  Â  Â  Â  Â  Â  .withSuccessHandler(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Report Synced", "Report data successfully saved to the Google Sheet.", false);
Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  .withFailureHandler(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Backend Sync Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Sync Failed", "Could not write data to Google Sheet. Check GAS logs.", true);
Â  Â  Â  Â  Â  Â  Â  Â })
Â  Â  Â  Â  Â  Â  Â  .recordFinalReport(dataToSend);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â /**
Â  Â  Â  Â  Â  * Loads and listens for all real-time state changes from Firestore.
Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â function loadStateFromFirestore() {
Â  Â  Â  Â  Â  Â  Â if (!db || !userId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Database or User ID is not initialized.");
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 1. Listen to the SHARED Clock/Break status
Â  Â  Â  Â  Â  Â  Â const clockRef = getClockStateRef();
Â  Â  Â  Â  Â  Â  Â onSnapshot(clockRef, async (docSnapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (docSnapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const sharedData = docSnapshot.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.isClockedIn = sharedData.isClockedIn || false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.isUserOnBreak = sharedData.isUserOnBreak || false;
Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await setDoc(clockRef, { isClockedIn: false, isUserOnBreak: false });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â renderStatus();Â 
Â  Â  Â  Â  Â  Â  Â }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error setting up clock listener:", error);
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 2. Listen to the SHARED Report Cutoff Timestamp
Â  Â  Â  Â  Â  Â  Â const reportStateRef = getReportStateRef();
Â  Â  Â  Â  Â  Â  Â onSnapshot(reportStateRef, async (docSnapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (docSnapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const reportData = docSnapshot.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.lastReportTimestamp = reportData.lastReportTimestamp || null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await setDoc(reportStateRef, { lastReportTimestamp: null });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â // When timestamp updates, the logs listener (4) will re-run automatically.
Â  Â  Â  Â  Â  Â  Â }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error setting up report state listener:", error);
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 3. Listen to the SHARED Tasks
Â  Â  Â  Â  Â  Â  Â const publicTasksRef = getPublicTasksCollectionRef();
Â  Â  Â  Â  Â  Â  Â onSnapshot(query(publicTasksRef, orderBy("createdAt", "desc")), (querySnapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â taskLoadingEl.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â taskLoadingEl.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const publicTasks = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â publicTasks.push({ id: doc.id, ...doc.data() });
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.tasks = publicTasks;
Â  Â  Â  Â  Â  Â  Â  Â  Â renderTasks();
Â  Â  Â  Â  Â  Â  Â }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error setting up public task listener:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â taskLoadingEl.textContent = 'Error loading shared tasks.';
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 4. Listen to the SHARED Time Logs (FULL HISTORY)
Â  Â  Â  Â  Â  Â  Â const logsQuery = query(getTimeLogCollectionRef(), orderBy("timestamp", "desc"));
Â  Â  Â  Â  Â  Â  Â onSnapshot(logsQuery, (querySnapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â historyLoadingEl.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â historyLoadingEl.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â printReportBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â markReportedBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const allLogs = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â querySnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // CRITICAL CHANGE: Capture the document ID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â allLogs.push({ id: doc.id, ...doc.data() });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â rawLogEvents = allLogs; // Store the raw events with IDs
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Calculate time segments and totals based on current cutoff date
Â  Â  Â  Â  Â  Â  Â  Â  Â // Note: calculateReportData sorts the logs internally by ascending timestamp
Â  Â  Â  Â  Â  Â  Â  Â  Â const report = calculateReportData(allLogs, currentState.lastReportTimestamp);
Â  Â  Â  Â  Â  Â  Â  Â  Â currentReportData = report; // Store the new calculated report data
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Render the currently selected view (Segments or Raw Events)
Â  Â  Â  Â  Â  Â  Â  Â  Â renderMainLogView();
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error setting up time log listener:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â historyLoadingEl.textContent = 'Error loading session history.';
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â async function saveSharedClockState() {
Â  Â  Â  Â  Â  Â  Â if (!db) return;
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const clockRef = getClockStateRef();
Â  Â  Â  Â  Â  Â  Â  Â  Â await setDoc(clockRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isClockedIn: currentState.isClockedIn,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isUserOnBreak: currentState.isUserOnBreak
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error saving shared clock state:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Save Error", "Failed to save shared clock status to the cloud database.", true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Task CRUD Operations (Same as before) ---
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.toggleTaskCompletion = async function(taskId, currentStatus) {
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const taskRef = doc(db, getPublicTasksCollectionRef().path, taskId);
Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(taskRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isCompleted: !currentStatus
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error toggling task completion:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Task Error", "Failed to update task status.", true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.deleteTask = async function(taskId) {
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const taskRef = doc(db, getPublicTasksCollectionRef().path, taskId);
Â  Â  Â  Â  Â  Â  Â  Â  Â await deleteDoc(taskRef);
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error deleting task:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Task Error", "Failed to delete task.", true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // --- Event Handlers (mostly same) ---
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleClockToggle = async function() {
Â  Â  Â  Â  Â  Â  Â const newState = !currentState.isClockedIn;
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (currentState.isClockedIn && currentState.isUserOnBreak) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // If clocking out while on break, log break end and clock out
Â  Â  Â  Â  Â  Â  Â  Â  Â await logTimeEvent('BREAK_END');
Â  Â  Â  Â  Â  Â  Â  Â  Â await logTimeEvent('CLOCK_OUT');
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.isClockedIn = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.isUserOnBreak = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Session Ended", "Clocked out and ended break (synced).", false);
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â const eventType = newState ? 'CLOCK_IN' : 'CLOCK_OUT';
Â  Â  Â  Â  Â  Â  Â  Â  Â await logTimeEvent(eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.isClockedIn = newState;
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!newState) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentState.isUserOnBreak = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage(newState ? "Clocked In (Synced)!" : "Clocked Out (Synced)!", `You are now ${newState ? 'working' : 'off'}.`, false);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â saveSharedClockState();
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleBreakToggle = async function() {
Â  Â  Â  Â  Â  Â  Â if (!currentState.isClockedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Action Blocked", "You must be clocked in to start or end a break.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const newState = !currentState.isUserOnBreak;
Â  Â  Â  Â  Â  Â  Â const eventType = newState ? 'BREAK_START' : 'BREAK_END';
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â await logTimeEvent(eventType);
Â  Â  Â  Â  Â  Â  Â currentState.isUserOnBreak = newState;
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â showMessage(newState ? "Break Started (Synced)" : "Break Ended (Synced)", `Time logging is ${newState ? 'paused' : 'resumed'}.`, false);
Â  Â  Â  Â  Â  Â  Â saveSharedClockState();
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleCalendarClick = function() {
Â  Â  Â  Â  Â  Â  Â showDatePicker = !showDatePicker;
Â  Â  Â  Â  Â  Â  Â if (showDatePicker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â dueDateContainerEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â dueDateContainerEl.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â newDueDateEl.value = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â newDueDate = null;Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleAddTask = async function() {
Â  Â  Â  Â  Â  Â  Â const text = newTaskTextEl.value.trim();
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (text.length < 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Input Required", "Please enter a task description that is at least 3 characters long.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (!db || !userId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("DB Error", "Authentication not ready. Cannot add task.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const publicTasksRef = getPublicTasksCollectionRef();
Â  Â  Â  Â  Â  Â  Â  Â  Â await addDoc(publicTasksRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â text: text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isCompleted: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ownerId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â createdAt: new Date(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dueDate: newDueDate || nullÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â newTaskTextEl.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â newDueDateEl.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â newDueDate = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â showDatePicker = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â dueDateContainerEl.classList.add('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Task Added", `Synced task '${text}' added!`, false);
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error adding public task:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Save Error", `Failed to save public task. Error: ${e.message}`, true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handlePrintReport = function() {
Â  Â  Â  Â  Â  Â  Â // This function triggers the print dialogue, relying on the @media print CSS to format the output.
Â  Â  Â  Â  Â  Â  Â window.print();
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â window.handleMarkReported = async function() {
Â  Â  Â  Â  Â  Â  Â if (!db || !userId) return;
Â  Â  Â  Â  Â  Â  Â const now = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â sendReportDataToServer(currentReportData, now);
Â  Â  Â  Â  Â  Â  Â  Â  Â const reportStateRef = getReportStateRef();
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(reportStateRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lastReportTimestamp: now
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Report Cleared", "All current hours have been marked as reported. The report summary is reset.", false);
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error marking hours as reported:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Report Error", `Failed to mark hours as reported: ${e.message}`, true);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â 
/**
Â * Handles the entire Firebase initialization and authentication process.
Â * This version uses Google Sign-In (OAuth) and authorization via Firestore check.
Â */
async function initializeFirebaseAndAuth() {
Â  Â  try {
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Use local persistence to keep the user signed in across sessions/reloads
Â  Â  Â  Â  await setPersistence(auth, browserLocalPersistence);

Â  Â  Â  Â  // --- Authentication Flow ---
Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  // Disable all buttons immediately until state is determined
Â  Â  Â  Â  Â  Â  clockToggleBtn.disabled = true;
Â  Â  Â  Â  Â  Â  breakToggleBtn.disabled = true;
Â  Â  Â  Â  Â  Â  addTaskBtn.disabled = true;
Â  Â  Â  Â  Â  Â  printReportBtn.disabled = true;
Â  Â  Â  Â  Â  Â  markReportedBtn.disabled = true;
Â  Â  Â  Â  Â  Â  manageLogsBtn.disabled = true;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  const userEmail = user.email;Â 

Â  Â  Â  Â  Â  Â  Â  Â  // ðŸ›‘ CRITICAL NULL CHECK: If the email is null or empty, the user session is bad.
Â  Â  Â  Â  Â  Â  Â  Â  if (!userEmail || userEmail.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  auth.signOut(); // Force immediate sign-out
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Authentication failed: User object returned with null or empty email.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Login Failed", "Could not retrieve user email address. Please sign in again.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Exit function and fall to the !user logic
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ðŸŸ¢ AUTHORIZATION CHECK
Â  Â  Â  Â  Â  Â  Â  Â  const isAuthorized = await checkAuthorization(userEmail);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isAuthorized) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // User is authenticated AND authorized: proceed to load the app
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('login-container').classList.add('hidden'); // Hide login prompt

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId = user.uid; // Keep tracking UID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userIdDisplayEl.textContent = userEmail; // Display email for better user context
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userIdDisplayEl.classList.remove('loading-text', 'loading-shimmer', 'text-red-500');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enable all functional controls
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clockToggleBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  breakToggleBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTaskBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  printReportBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  markReportedBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manageLogsBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Load real-time data for the authenticated user
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadStateFromFirestore();Â 

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // User is authenticated but NOT authorized: force sign-out and show access denied.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  auth.signOut(); // Log them out immediately
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('google-sign-in-btn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('google-sign-in-btn').textContent = "Access Denied";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Access Denied", `The Google account (${userEmail}) is not authorized to use this application.`, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fall through to the 'else' block below to display the sign-in container
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  Â  Â  // User is signed out or access was just denied.
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('login-container').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  userIdDisplayEl.textContent = 'Signed Out';
Â  Â  Â  Â  Â  Â  Â  Â  userIdDisplayEl.classList.remove('loading-text', 'loading-shimmer');
Â  Â  Â  Â  Â  Â  Â  Â  userIdDisplayEl.classList.add('text-red-500');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Custom token logic is removed/omitted.

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Firebase Initialization Error:", e);
Â  Â  Â  Â  userIdDisplayEl.textContent = 'Error (DB Failed)';
Â  Â  Â  Â  userIdDisplayEl.classList.remove('loading-text', 'loading-shimmer');
Â  Â  Â  Â  showMessage("Initialization Failed", `Could not connect to Firebase: ${e.message}. The app is non-functional.`, true);
Â  Â  }
}

Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // New function outside of initializeFirebaseAndAuth
Â  Â  Â  Â  Â window.handleGoogleSignIn = function() {
Â  Â  const auth = getAuth();
Â  Â  const provider = new GoogleAuthProvider();

Â  Â  signInWithPopup(auth, provider)
Â  Â  .then((result) => {
Â  Â  Â  Â  // Sign-in successful. onAuthStateChanged listener handles the rest.
Â  Â  Â  Â  console.log("Google Sign-in successful.");
Â  Â  })
Â  Â  .catch((error) => {
Â  Â  Â  Â  // Handle Errors (e.g., user closed the popup, or permission denied)
Â  Â  Â  Â  console.error("Google Sign-In Failed:", error);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let errorMessage = `Reason: ${error.code}`;
Â  Â  Â  Â  if (error.code === 'auth/popup-closed-by-user') {
Â  Â  Â  Â  Â  Â  Â errorMessage = "Sign-in popup closed. Please try again.";
Â  Â  Â  Â  }
Â  Â  Â  Â  showMessage("Sign-in Failed", `Could not complete Google sign-in. ${errorMessage}`, true);
Â  Â  });
}
Â  Â  Â  Â  Â 
/**
Â * Handles the Google Sign-In pop-up, triggered by the user clicking the button.
Â */
window.handleGoogleSignIn = function() {
Â  Â  const auth = getAuth();
Â  Â  const provider = new GoogleAuthProvider();

Â  Â  signInWithPopup(auth, provider)
Â  Â  .then((result) => {
Â  Â  Â  Â  // Sign-in successful. onAuthStateChanged listener handles UI update.
Â  Â  Â  Â  console.log("Google Sign-in successful.");
Â  Â  })
Â  Â  .catch((error) => {
Â  Â  Â  Â  // Handle Errors (e.g., user closed the popup, network issues)
Â  Â  Â  Â  console.error("Google Sign-In Failed:", error);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let errorMessage = `Reason: ${error.code}`;
Â  Â  Â  Â  if (error.code === 'auth/popup-closed-by-user') {
Â  Â  Â  Â  Â  Â  Â errorMessage = "Sign-in popup closed. Please try again.";
Â  Â  Â  Â  }
Â  Â  Â  Â  showMessage("Sign-in Failed", `Could not complete Google sign-in. ${errorMessage}`, true);
Â  Â  });
}

/**
Â * Checks if the signed-in user's email exists in the Firestore authorizedUsers collection.
Â * This function requires a single, valid document to exist with the user's email as the ID.
Â * @param {string} email - The user's authenticated email address.
Â * @returns {Promise<boolean>} True if authorized, false otherwise.
Â */
async function checkAuthorization(email) {
Â  Â  if (!db) return false;

Â  Â  // Normalize email to lowercase (as done in the database)
Â  Â  const normalizedEmail = email.toLowerCase();
Â  Â Â 
Â  Â  // Path: artifacts/{appId}/public/data/authorizedUsers/{email}
Â  Â  const authDocPath = `artifacts/${appId}/public/data/authorizedUsers/${normalizedEmail}`;
Â  Â  const authRef = doc(db, authDocPath);
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  // Fetch the single document
Â  Â  Â  Â  const docSnap = await getDoc(authRef);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Authorization is granted if the document exists
Â  Â  Â  Â  return docSnap.exists();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error checking authorization:", e);
Â  Â  Â  Â  // Fail safe: If there's a database error, assume not authorized
Â  Â  Â  Â  return false;Â 
Â  Â  }
}

/**
Â * Fetches ALL raw log events from Firestore, serializes them into a JSON string,
Â * and sends this string to the GAS backend for reliable writing to the Sheet.
Â */
window.syncRawLogsToSheet = function() {
Â  Â  if (!userId) {
Â  Â  Â  Â  showMessage("Sync Error", "Please sign in before syncing data.", true);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (rawLogEvents.length === 0) {
Â  Â  Â  Â  showMessage("Sync Status", "No log events found to sync.", false);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 1. Filter to ensure we only process log objects with timestamps and types (which includes REPORTED)
Â  Â  const validRawLogs = rawLogEvents.filter(log => log.timestamp && log.type);Â 

Â  Â  if (validRawLogs.length === 0) {
Â  Â  Â  Â  showMessage("Sync Status", "Log history contains no readable entries.", false);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 2. Map the data, enforcing all values are simple strings for serialization safety.
Â  Â  const simpleLogsArray = validRawLogs.map(log => {
Â  Â  Â  Â  // Guarantee simple string conversion for the final array structure: [Timestamp, Type, Status]
Â  Â  Â  Â  // NOTE: The 'REPORTED' entry's metadata is stored in the 'Status' field, so we must include it.
Â  Â  Â  Â  return [
Â  Â  Â  Â  Â  Â  String(log.timestamp) || 'CORRUPT_TIMESTAMP',
Â  Â  Â  Â  Â  Â  String(log.type) || 'ACTION_MISSING',
Â  Â  Â  Â  Â  Â  String(log.status || '') // Ensure the status (metadata) is included if it exists
Â  Â  Â  Â  ];
Â  Â  }).reverse(); // Reverse the order to show oldest logs first in the Sheet

Â  Â  // 3. Serialize the entire array into a single JSON string for reliable transfer.
Â  Â  const jsonStringToSend = JSON.stringify(simpleLogsArray);

Â  Â  showMessage("Syncing", "Transferring all log history to Google Sheet...", false);

Â  Â  // Call the correct GAS function
Â  Â  google.script.run
Â  Â  Â  Â  .withSuccessHandler(() => {
Â  Â  Â  Â  Â  Â  showMessage("Sync Complete", `Successfully synced ${simpleLogsArray.length} log entries to the spreadsheet.`, false);
Â  Â  Â  Â  })
Â  Â  Â  Â  .withFailureHandler(error => {
Â  Â  Â  Â  Â  Â  console.error("Sheet Sync Failed:", error);
Â  Â  Â  Â  Â  Â  showMessage("Sync Failed", `Could not write data to sheet. Error: ${error.message}`, true);
Â  Â  Â  Â  })
Â  Â  Â  Â  .writeRawLogsFromJson(jsonStringToSend);Â 
}
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // Start the application initialization when the window loads.
Â  Â  Â  Â  Â window.onload = initializeFirebaseAndAuth;
Â  Â  Â  Â  Â 
Â  Â  Â  </script>
Â  Â </body>
</html>