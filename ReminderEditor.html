<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Basic, clean styling for the Apps Script sidebar */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 12px;
      background-color: #f8f9fa;
      color: #3c4043;
    }
    h4 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #1a73e8;
    }
    p.instructions {
      font-size: 0.85em; 
      color: #5f6368;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    /* Card styling for each reminder */
    .reminder-container {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
    }
    .reminder-container:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* NEW: Overdue style to draw attention */
    .overdue-reminder {
      border: 2px solid #ea4335; /* Strong red border */
      background-color: #fce8e6; /* Light red background */
    }

    /* Flex row for the top part (Checkbox + Text) */
    .row-top {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Flex row for the bottom part (Date + Remove) */
    .row-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding-top: 8px;
      border-top: 1px dashed #f1f3f4;
    }

    /* Input Styling */
    input[type="text"] {
      flex-grow: 1; /* Takes up remaining space */
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
    }
    input[type="text"]:focus {
      outline: 2px solid #1a73e8; /* Blue outline on focus */
      border-color: transparent;
    }

    input[type="date"] {
      padding: 6px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 13px;
      color: #5f6368;
    }

    input[type="checkbox"] {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* Button Styling */
    .action-button {
      background-color: #fbbc04; /* Yellow */
      color: #3c4043;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      margin-bottom: 10px;
    }
    .action-button:hover {
      background-color: #f7b400;
    }

    .remove-button {
      background-color: white;
      color: #ea4335; /* Red text */
      border: 1px solid #ea4335;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
    }
    .remove-button:hover {
      background-color: #fce8e6;
    }

    .save-button {
      background-color: #1a73e8; /* Blue */
      color: white;
      border: none;
      border-radius: 4px;
      padding: 12px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 14px;
    }
    .save-button:hover {
      background-color: #174ea6;
    }

    #loading {
      display: none;
      text-align: center;
      color: #5f6368;
      margin-top: 15px;
      font-size: 0.9em;
    }

    .label-small {
      font-size: 11px;
      color: #80868b;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <h4>Reminder List Editor</h4>
  <p class="instructions">
    Check items to complete them. Set a date for date-specific alerts, or leave the date empty for an alert every time. Overdue tasks are highlighted in red.
  </p>

  <div id="remindersList">
    <!-- Dynamic reminder items appear here -->
  </div>
  
  <button id="addButton" class="action-button" onclick="addReminder()">+ Add New Reminder</button>
  <button id="saveButton" class="save-button" onclick="saveReminders()">Save List</button>
  
  <div id="loading">Processing...</div>

  <script>
    document.addEventListener('DOMContentLoaded', loadReminders);

    const newReminderTemplate = {
      text: '',
      isCompleted: false,
      targetDate: null
    };

    /**
     * Helper function to get today's date in YYYY-MM-DD format for client-side comparison.
     */
    function getTodayDateString() {
        const now = new Date();
        const year = now.getFullYear();
        // Month is 0-indexed, so add 1 and pad
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- LOAD DATA ---
    function loadReminders() {
      toggleLoading(true);
      google.script.run
        .withSuccessHandler(displayReminders)
        .withFailureHandler(handleError)
        .getReminderList();
    }

    function displayReminders(listJson) {
      const reminders = JSON.parse(listJson);
      const listContainer = document.getElementById('remindersList');
      listContainer.innerHTML = ''; 
      
      if (reminders.length === 0) {
        reminders.push(newReminderTemplate);
      }
      
      reminders.forEach(reminder => {
        createReminderElement(reminder);
      });
      
      toggleLoading(false);
    }
    
    // --- CREATE UI ELEMENTS ---
    function createReminderElement(reminder) {
        const listContainer = document.getElementById('remindersList');
        
        // Main Card Container
        const container = document.createElement('div');
        container.className = 'reminder-container';
        
        // --- NEW LOGIC FOR OVERDUE HIGHLIGHTING ---
        const today = getTodayDateString();

        // Check if reminder is not completed AND has a target date AND that date is in the past
        if (!reminder.isCompleted && reminder.targetDate) {
            // Since targetDate is YYYY-MM-DD string, we can compare it directly.
            if (reminder.targetDate < today) {
                container.classList.add('overdue-reminder');
                container.title = "⚠️ This reminder is PAST DUE!";
            }
        }
        // -------------------------------------------
        
        // ROW 1: Checkbox + Text
        const rowTop = document.createElement('div');
        rowTop.className = 'row-top';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = reminder.isCompleted;
        checkbox.className = 'reminder-completed';
        checkbox.title = "Mark as done";

        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.value = reminder.text;
        textInput.className = 'reminder-text';
        textInput.placeholder = "Enter reminder description...";

        rowTop.appendChild(checkbox);
        rowTop.appendChild(textInput);

        // ROW 2: Date Label + Date Input + Remove Button
        const rowBottom = document.createElement('div');
        rowBottom.className = 'row-bottom';

        // Wrapper for date to keep label and input together
        const dateWrapper = document.createElement('div');
        
        const dateLabel = document.createElement('span');
        dateLabel.textContent = "Pop-up Date:";
        dateLabel.className = 'label-small';

        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.value = reminder.targetDate || '';
        dateInput.className = 'reminder-date';

        dateWrapper.appendChild(dateLabel);
        dateWrapper.appendChild(dateInput);

        const removeButton = document.createElement('button');
        removeButton.textContent = 'Remove';
        removeButton.className = 'remove-button';
        removeButton.onclick = () => container.remove();

        rowBottom.appendChild(dateWrapper);
        rowBottom.appendChild(removeButton);

        // Assemble
        container.appendChild(rowTop);
        container.appendChild(rowBottom);
        listContainer.appendChild(container);
    }
    
    function addReminder() {
      createReminderElement(newReminderTemplate);
    }

    // --- SAVE DATA ---
    function saveReminders() {
      const remindersList = [];
      const reminderContainers = document.querySelectorAll('.reminder-container');
      
      reminderContainers.forEach(container => {
        // We can query selector inside the specific container to find inputs
        const textInput = container.querySelector('.reminder-text');
        const dateInput = container.querySelector('.reminder-date');
        const checkbox = container.querySelector('.reminder-completed');
        
        remindersList.push({
          text: textInput.value.trim(),
          isCompleted: checkbox.checked,
          targetDate: dateInput.value || null 
        });
      });
      
      toggleLoading(true);
      google.script.run
        .withSuccessHandler(saveSuccess)
        .withFailureHandler(handleError)
        .saveReminderList(JSON.stringify(remindersList));
    }
    
    function saveSuccess() {
      toggleLoading(false);
      google.script.host.close();
    }

    // --- UTILITIES ---
    function handleError(error) {
      toggleLoading(false);
      alert("Error: " + error.message);
    }

    function toggleLoading(isLoading) {
      const loadingDiv = document.getElementById('loading');
      const saveBtn = document.getElementById('saveButton');
      const addBtn = document.getElementById('addButton');

      if (isLoading) {
        loadingDiv.style.display = 'block';
        saveBtn.disabled = true;
        addBtn.disabled = true;
      } else {
        loadingDiv.style.display = 'none';
        saveBtn.disabled = false;
        addBtn.disabled = false;
      }
    }
  </script>
</body>
</html>