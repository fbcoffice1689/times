<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f8f9fa;
      color: #3c4043;
    }
    h4 {
      margin-top: 0;
      color: #1a73e8;
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.9em;
    }
    input[type="datetime-local"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    input[type="datetime-local"]:focus {
      outline: 2px solid #1a73e8;
      border-color: transparent;
    }
    button {
      background-color: #1a73e8; /* Blue for Clock In */
      color: white;
      border: none;
      border-radius: 4px;
      padding: 12px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 16px;
      margin-top: 20px;
      transition: background-color 0.2s;
    }
    button:hover:not(:disabled) {
      background-color: #174ea6;
    }
    .clock-out-btn {
      background-color: #ea4335; /* Red for Clock Out */
    }
    .clock-out-btn:hover:not(:disabled) {
      background-color: #c5221f;
    }
    #loading {
      text-align: center;
      margin-top: 15px;
      color: #5f6368;
      display: none;
    }
  </style>
</head>
<body>
  <h4 id="statusTitle">Loading Status...</h4>
  <p id="statusMessage">Checking current clock status.</p>

  <form id="clockForm">
    <label for="dateTimeInput">Adjust Time (if needed):</label>
    <input type="datetime-local" id="dateTimeInput" required>
    
    <button type="button" id="clockButton" onclick="recordTime()">
      ...
    </button>
  </form>
  
  <div id="loading">Processing log entry...</div>

  <script>
    document.addEventListener('DOMContentLoaded', loadClockStatus);

    /**
     * Formats a Date object into the local YYYY-MM-DDTHH:MM string 
     * required by <input type="datetime-local">. This ensures the browser 
     * correctly displays the user's local time without UTC offset issues.
     */
    function formatLocalTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function loadClockStatus() {
      // Get the current status from the server
      google.script.run
        .withSuccessHandler(initializeUI)
        .withFailureHandler(handleError)
        .getClockStatus();
    }

    function initializeUI(isClockedIn) {
      const now = new Date();
      // Use the new helper function to format local time correctly
      const formattedDateTime = formatLocalTime(now); 
      
      document.getElementById('dateTimeInput').value = formattedDateTime;
      
      const title = document.getElementById('statusTitle');
      const message = document.getElementById('statusMessage');
      const button = document.getElementById('clockButton');

      if (isClockedIn) {
        title.textContent = 'Clock Out';
        message.innerHTML = 'You are currently **Clocked IN**. <br>Press the button below to Clock OUT.';
        button.textContent = 'Clock OUT';
        button.classList.add('clock-out-btn');
      } else {
        title.textContent = 'Clock In';
        message.innerHTML = 'You are currently **Clocked OUT**. <br>Press the button below to Clock IN.';
        button.textContent = 'Clock IN';
        button.classList.remove('clock-out-btn');
      }
    }

    function recordTime() {
      const dateTimeString = document.getElementById('dateTimeInput').value;
      if (!dateTimeString) {
        alert("Please select a valid date and time.");
        return;
      }

      document.getElementById('loading').style.display = 'block';
      document.getElementById('clockButton').disabled = true;

      // Pass the edited date/time string back to the server function.
      // Apps Script (server) will interpret this string based on the Sheet's
      // time zone (CST), ensuring synchronization.
      google.script.run
        .withSuccessHandler(closeSidebar)
        .withFailureHandler(handleError)
        .recordTimeLog(dateTimeString);
    }
    
    function closeSidebar() {
      // The server function already displays an alert, so we just close the UI
      google.script.host.close();
    }

    function handleError(error) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('clockButton').disabled = false;
      alert("An error occurred: " + error.message);
    }
  </script>
</body>
</html>